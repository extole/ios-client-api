#!/usr/bin/env bash
set -eu
set -o pipefail

project_root=$(cd $(dirname ${BASH_SOURCE:-$0})/.. && pwd)

temp_location=${project_root}/temp
rm -rf $temp_location

mkdir -p ${temp_location}

cd $temp_location

open_api_location="http://client-api-private.pr.intole.net/client-api/api/openapi.json"
client_api_openapi_json_file_location=${temp_location}/client-openapi.json
swagger_codegen_location=${temp_location}/swagger-codegen-cli.jar
swagger_codegen_extole_module_location=${temp_location}/cli-api.jar

curl $open_api_location --output $client_api_openapi_json_file_location
curl https://repo1.maven.org/maven2/io/swagger/codegen/v3/swagger-codegen-cli/3.0.27/swagger-codegen-cli-3.0.27.jar --output $swagger_codegen_location
curl http://artifactory.tools.intole.net/artifactory/extole-packages/openapi/com/extole/cli-api/1.0.5/cli-api-1.0.5.jar --output $swagger_codegen_extole_module_location

java -DapiDocs=false -DmodelDocs=false -DapiTests=false -cp ${swagger_codegen_extole_module_location}:${swagger_codegen_location}  io.swagger.codegen.v3.cli.SwaggerCodegen \
    generate \
    -i "$client_api_openapi_json_file_location" \
    -l swift5 \
    -o "$project_root" \
    --type-mappings object=String \
    -c $project_root/bin/swift_client_api_codegen_config.json

cd $project_root

java_type_file=$(find . -type f -name "JavaType.swift")
sed -i '' 's/struct/class/g' $java_type_file

# # https://extole.atlassian.net/browse/ENG-15224 will fix below replacements
# v2_persons_api_file=$(find . -type f -name "V2personsAPI.swift")
# sed -i -- 's/open class func isSamePerson(personId: String, personId: String? = nil/open class func isSamePerson(personId: String, secondPersonId: String? = nil/g' $v2_persons_api_file
# sed -i -- 's/open class func isSamePersonWithRequestBuilder(personId: String, personId: String? = nil)/open class func isSamePersonWithRequestBuilder(personId: String, secondPersonId: String? = nil)/g' $v2_persons_api_file
# sed -i -- 's/isSamePersonWithRequestBuilder(personId: personId, personId: personId)/isSamePersonWithRequestBuilder(personId: personId, secondPersonId: secondPersonId)/g' $v2_persons_api_file
# sed -i -- 's/\"person_id\": personId/\"person_id\": secondPersonId/g' $v2_persons_api_file

# v4_runtime_persons_api_file=$(find . -type f -name "V4runtimePersonsAPI.swift")
# sed -i -- 's/open class func isSamePerson2(personId: String, personId: String? = nil/open class func isSamePerson2(personId: String, secondPersonId: String? = nil/g' $v4_runtime_persons_api_file
# sed -i -- 's/open class func isSamePerson2WithRequestBuilder(personId: String, personId: String? = nil)/open class func isSamePerson2WithRequestBuilder(personId: String, secondPersonId: String? = nil)/g' $v4_runtime_persons_api_file
# sed -i -- 's/isSamePerson2WithRequestBuilder(personId: personId, personId: personId)/isSamePerson2WithRequestBuilder(personId: personId, secondPersonId: secondPersonId)/g' $v4_runtime_persons_api_file
# sed -i -- 's/\"person_id\": personId/\"person_id\": secondPersonId/g' $v4_runtime_persons_api_file

# Consumer API generation

# consumer_api_lib_folder="ExtoleConsumerApiSwiftLibrary"

# mkdir -p $E_API_HOME/bin/tmp/

# curl -X GET "http://consumer-api-private.pr.intole.net/consumer-api/openapi.json" -H "X-Extole-Incoming-Url: https://vokate.extole.io" \
#     --output $E_API_HOME/bin/tmp/consumer-openapi.json

# rm -rf $consumer_api_lib_folder

# java -DapiDocs=false -DmodelDocs=false -DapiTests=false -jar $E_API_HOME/bin/lib/swagger-codegen-cli.jar \
#     generate \
#     -i $E_API_HOME/bin/tmp/consumer-openapi.json \
#     -l swift5 \
#     -o $consumer_api_lib_folder \
#     --type-mappings object=String \
#     -c $E_API_HOME/bin/swift_consumer_api_codegen_config.json
